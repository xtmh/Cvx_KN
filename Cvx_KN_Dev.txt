////////////////////////////////////
//
//	SD-OCT Cylinder Viewer
//	developed by TY-Techno
//	since 9/25 2014
//	
////////////////////////////////////
Version	Date	Development
-----------------------------------------------
000		140925	開発開始(Cve継承)
				highgui.h削除
				cv.h削除
001		140925	OpenCVﾗｲﾌﾞﾗﾘ削除
				uchar定義追加
002		140925	画像ｻｲｽﾞを1024x1900に変更
				c:\temp\Sdz\CvcImage\src.jpgをﾀﾞﾐｰ画像として読み出し
				元画像を90°回転して表示
003		140925	画像ﾀｲﾄﾙ修正
004		140925	画像ﾚｲｱｳﾄ修正
005		140925	仮画像生成処理で100枚の画像をimgﾌｫﾙﾀﾞに作製
006		140925	座標ｼﾌﾄ画像生成
007		140925	全ﾌﾚｰﾑ画像をﾒﾓﾘﾛｰﾄﾞする処理を実装
008		140925	極座標画像用ﾒﾓﾘuPol[]を確保
				極座標表示
009		140925	背景を白化
				ﾋﾟｰｸ検出処理を実装
010		140925	IDC_CIRCをｻﾌﾞｸﾗｽ化	
				uPol[]をImageｺﾝﾄﾛｰﾙに表示するように修正
				平均ﾋﾟｰｸをと差分値円を描画
011		140925	OnBnClickedCalc()でuSrc[]を変更しないように修正
				三角関数の演算をﾃｰﾌﾞﾙ参照に置換
012		140925	ｽﾗｲﾀﾞｰ制御で画像No.を選択できるように修正
				起動時にuFrm[]へｼﾌﾄ画像生成
				ｴﾃﾞｨｯﾄの変更処理を修正
013		140925	不要な処理削除
				一部PYをPDに修正
014		141010	使用確定に伴う定数変更
				PYを1900->1270に修正
				PDを1900->1024に修正
				起動時読み込み画像をsrc_1270.jpgに変更
				ﾀﾞｲｱﾛｸﾞｻｲｽﾞ変更
015		141010	PFを100->30に変更
				ｽﾗｲﾀﾞｰｺﾝﾄﾛｰﾙの最大値をPF-1に修正
				ｽﾗｲﾀﾞｰｺﾝﾄﾛｰﾙの範囲表示をPF-1上限になるように修正
016		141014	CORE_Dを500->100に変更
				CORE_DをCORE_Rに変更
				ｺｱ径を可変に変更
				imgPol()で座標が領域外にならないように修正
017		141014	AllOpenﾎﾞﾀﾝをLoadに変更(SDZに合わせる)
018		141014	m_nSldCoreの範囲を0-300に設定
				m_nSldCoreが半径の扱いになうるように修正
019		141014	OCT画像表示ｻｲｽﾞ変更
020		141023	PY=1250に変更
021		141030	OnPaint()でhBmpとhdcをDeleteObject()するように修正
				OnPaint()で転送先仮想ｲﾒｰｼﾞｻｲｽﾞをPXとPYに変更
022		141219	Z_RVSでZ軸反転
				imgPeak()でのﾋﾟｰｸ探索時にnPkPos[]を0で初期化
				src[]の値が50未満の場合はﾋﾟｰｸ検出をﾊﾟｽ
				CircのOnPaint()でnPkPos[]が0の場合にはﾗｲﾝ描画をﾊﾟｽ
023		141219	CircのOnPaint()で偏差ﾗｲﾝの開始点が原点にならないように修正
				同様に平均値から50以上離れている場合は描画ﾊﾟｽ
024		141222	OnPaint()のPlgBlt()用のPOINT座標修正
025		141222	ﾃｷｽﾄ出力の文字色変更
		150123	ﾌｫﾝﾄｻｲｽﾞ変更
		150220	<TYTへ送付>
///////////////////////////////////////////////////////////////////////////////
//		OCTﾃﾞｰﾀ解析用に改造
100		151013	img.jpgを表示
101		151013	oct.rawﾃﾞｰﾀ読込
				画像の向きを調整して表示確認
102		151013	全ﾌﾚｰﾑをuFrmへ読込
103		151013	ｽﾗｲﾀﾞｰﾊﾞｰで1023までのﾌﾚｰﾑを可変ｽｸﾛｰﾙ対応
104		151014	CCircでのuSfcの表示ﾓｰﾄﾞを指定(黒潰れ対策)
				開いたrawﾌｧｲﾙのﾌﾙﾊﾟｽ表示
				湾曲補正処理のｺｰﾙ部分を作成
				出力用ﾒﾓﾘuFroを用意
105		151014	湾曲補正処理を実装
				補正係数CURVEを設定
				□10mmの補正値を基準に係数SCALEを設定
106		151014	ﾚｲｱｳﾄ修正
				上面視画像にｽﾗｲｽﾗｲﾝを描画
				CCirc上でのﾏｳｽﾑｰﾌﾞに対応
107		151014	CveDlgの描画画像にｽﾗｲｽﾗｲﾝを描画
108		151014	CveDlgのｽﾗｲｽﾗｲﾝで断面切り替え
109		151014	ｽﾗｲﾀﾞｰ2でｽﾗｲｽﾚﾍﾞﾙ操作できるように修正
				出力とﾀｲﾄﾙ表示ををcvxに変更
110		151015	ﾚｲｱｳﾄ変更
				Z_RVSを設定してZ軸反転
				疑似ｶﾗｰﾏｯﾌﾟ追加
				疑似ｶﾗｰ表示機能追加
111		151015	ｽﾗｲｽﾗｲﾝを赤で描画するように修正
				Topview表示を削除
///////////////////////////////////////////////////////////////////////////////
//	Cvxに変更
112		151023	左ｸﾘｯｸ操作を右ｸﾘｯｸに変更
				Circの左ｸﾘｯｸでｸﾘｯｸ座標を維持してｵﾘｼﾞﾅﾙｻｲｽﾞ画像表示
				ｸﾘｯｸ座標値をﾗﾍﾞﾙに表示
113		151023	Circの左ｸﾘｯｸ時のﾑｰﾌﾞ動作でﾑｰﾌﾞ座標値取得
				ﾑｰﾌﾞ座標値をﾗﾍﾞﾙに表示
		151026	<TYTへ送付>
114		151109	ﾋﾟｰｸ点座標保持用にCPeakｸﾗｽ作成
				画像ﾛｰﾄﾞ時にﾋﾟｰｸ位置を保持
				ﾋﾟｰｸ表示のﾁｪｯｸﾎﾞｯｸｽでﾋﾟｰｸ位置画像表示
115		151110	ﾋﾟｰｸ検出のﾁｪｯｸでimgSlc()をｺｰﾙして表面画像を再描画
				imgOpen()でのXY軸整合
				Dialogでのﾏｳｽ左ﾎﾞﾀﾝｱｯﾌﾟをCCircへ通知するよう修正(拡大のﾘﾘｰｽ)
				ｽﾗｲﾀﾞｰを縦に配置
116		151110	imgFitting()でaが0の時はﾋﾟｰｸ点を0に設定
				imgPeak()でのXY軸整合
				peak.csvへ頂点位置を出力
117		151110	FIT_NUMを7->11へ変更
118		151110	imgPeak()でのXY軸交換
				imgPeak()で参照するﾃﾞｰﾀをuOctからuFroに変更
				X軸湾曲評価(補正していないので変化なし)
				Y軸湾曲評価(補正されるがｽﾃｯﾌﾟ変動あり)
119		151110	CURVEを60->65に変更して湾曲補正を最適化
120		151110	CPeakｸﾗｽﾒﾝﾊﾞ追加
121		151111	画像ﾛｰﾄﾞ時にｶｰﾌﾞﾌｨｯﾃｨﾝｸﾞを実行
				peak.csvにFIT_NUM数分のﾃﾞｰﾀ出力するように修正
122		151111	imgPeak()に近傍平均値算出処理を実装
				imgPeak()をimgCvFit()に変更
				imgNrAvg()で近傍点平均値算出
				imgLwSub()で下限値からの差分値算出
123		151111	dSub値のﾊﾞｯｸｱｯﾌﾟ用にdSubBkを作成
				基準面計測用ﾎﾞﾀﾝIDC_REFを追加
				基準面計測時にはbRefでOnBnClickedOpen()内の処理を切り替え
				OnBnClickedOpen()で基準面の場合にはpkDepthでpkRefを更新
				試料計測の場合はimgMeas()で基準面で算出した差分値で面補正
124		151111	OKﾎﾞﾀﾝをExitに変更
				ﾏｳｽ右ｸﾘｯｸﾑｰﾌﾞでm_strXYにZ座標(dSmp)表示
				基準面による補正時にCPeak配列をreference.datとして保存
				起動時にreference.datを読み込むように修正
				ｽﾃｰﾀｽとして「補正値Ready」表示
125		151111	imgSurface()で±10umの範囲を8bitに正規化してnOrgへ算出
				m_bPeakのﾁｪｯｸでnOrgを表示
126		151111	Y-Z断面に断層ﾌﾟﾛﾌｧｲﾙを紫で描画
				平均ﾚﾍﾞﾙを緑の点線で描画
127		151112	sdzﾌｫﾙﾀﾞの使用を停止
				umへの換算用にUM_RATI=1.5を設定
				imgSurface()で距離換算
				imgMeas()で湾曲補正をしない場合の処理を仮実装
128		151113	湾曲補正有無をﾁｪｯｸﾎﾞｯｸｽm_bCurで選択
129		151113	断層ﾌﾟﾛﾌｧｲﾙ表示に基準線描画
				imgRcv()での断層画像の湾曲補正処理をdSubで実装
130		151113	起動時のOnBnClickedCalc()をﾊﾟｽ
				uFrmとuFroを単色配列に変更してﾒﾓﾘ使用抑制
				不要な配列削除
131		151113	imgLwSub()でdAvgが0の際にdMinに設定しないように修正
				⇒reference.datを更新(重要)
				画像の湾曲補正確認
132		151113	湾曲補正画像の背景を白から黒に変更
				湾曲補正画像切り替えをimgCurv()に集約して処理を軽量化
133		151113	±10umを表示
				ﾋﾟｰｸ画像表示時にﾏｳｽﾑｰﾌﾞをﾊﾟｽ
134		151114	UM_RANGEでﾌﾟﾛﾌｧｲﾙ表示範囲を設定できるように修正
				ﾚﾝｼﾞを±20umに設定
				Z_RVSを無効にして断層像の上下反転
135		151115	imgChg()でのｽﾗｲｽﾚﾍﾞﾙも反転
				imgSlc()でm_bCurvで表示画像を切り替え
				Saveﾎﾞﾀﾝ設置
				ｽﾗｲｽ画像保存機能実装
136		151115	保存画像ｻｲｽﾞをｵﾘｼﾞﾅﾙｻｲｽﾞ(1024x1024)に変更
137		151116	0umの表示を追加
				OnPaint()でのSelectObjectの後処理を実装
				SelectObjectにﾎﾟｲﾝﾀで入力するように修正
138		151116	ReleaseﾋﾞﾙﾄﾞでOpenMPｻﾎﾟｰﾄ
				m_strDetにﾌｧｲﾙｵｰﾌﾟﾝ時の処理時間表示
				imgOpen()にOpenMP実装(27.8->25.1s)
				imgRcv()にOpenMP実装(25.1->17.8s)
139		151116	imgSlc()とimgChg()へOpenMP実装
140		151116	断面画像を名前を付けて保存できるように修正
141		151117	imgRcv()とimgCvFit()へOpenMP実装(17.8->13s)
142		151117	CveDlgのOnPaint()でのﾌﾟﾛﾌｧｲﾙ描画で異常値を表示しないように修正
143		151117	ﾄﾞﾛｯﾌﾟﾀﾞｳﾝﾘｽﾄﾎﾞｯｸｽによる描画ﾚﾝｼﾞ切り替え
144		151117	ｶﾗﾊﾞｰ表示
				ﾏｳｽﾑｰﾌﾞでのZ値表示修正
				imgSurface()での高さ換算修正
				imgOpen()でのuSum[]計算を削除
				OnBnClicked()の演算部をimgCalc()へ集約
145		151117	Lz4圧縮ﾃｽﾄ
				ﾃﾞﾊﾞｯｸﾞﾓｰﾄﾞでのﾌﾟﾘｺﾝﾊﾟｲﾙ済みﾍｯﾀﾞｰの使用停止
146		151117	圧縮変換処理を実装(*.raw -> *.oct)
				圧縮時にﾌｫﾙﾀﾞ名をﾌｧｲﾙ名にするように修正
				OnBnClickedOct()で圧縮ﾌｧｲﾙの読み出しに対応
				ﾌｧｲﾙを開く処理をfileOpen()に集約
147		151118	断層ﾌﾟﾛﾌｧｲﾙ表示に機能名を変更
				Z_RVSによるZ軸反転対応
148		151118	Z_RVSによるZ軸反転処理修正
				imgSlc()とimgChg()の色ﾃﾞｰﾀをmemcpy()とmemset()で実装
149		151118	reference.datもLz4圧縮(131->42MB)
				fileOpen()で拡張子がrawかoctかを判断して処理を分岐
				fileOpen()の引数を削除
				ｽﾗｲｽﾗｲﾝを点線に変更
				uTmpの破棄処理を削除(ｴﾗｰ対応)
150		151118	uOct[]とuLz4[]の使用を停止してﾒﾓﾘ削減
				Win32での動作確認
151		151118	imgRcv()の処理をimgCalc()へ取り込み
152		151118	uTmp[]を削除
				imgCalc()でのuDsp[]を使用停止
		151119	(TYT経由KNへ送付)
----------------------------------------------------------------------------
<TMEJ向け仕様>
153		151119	湾曲補正を非表示
				断層ﾌﾟﾛﾌｧｲﾙ表示を非表示
				表示ﾚﾝｼﾞのｺﾝﾎﾞﾎﾞｯｸｽを非表示
				各ｴﾃﾞｨｯﾄｺﾝﾄﾛｰﾙを非表示
				ｷｬﾘﾌﾞﾚｰｼｮﾝﾎﾞﾀﾝを非表示
				圧縮変換処理ﾎﾞﾀﾝを非表示
154		151120	tempﾌｫﾙﾀﾞの使用停止
		151120	(TMEJへDVDで送付)
155		160112	imgOpen()でﾌｧｲﾙｻｲｽﾞにより解像度を判断して処理
				imgExp2()で解像度2倍に拡張して表示
156		160118	圧縮処理2を追加(□512:131MB->14MB)
				LZ4SIZE(40MB)を境に画像ｻｲｽﾞを推定してLz4解凍からの画像展開を実装
156x	160119	imgExp2()でのﾒﾓﾘ転送検証用
157		160119	imgExp2()をｼﾝｸﾞﾙﾎﾟｲﾝﾀによるｺﾋﾟｰに修正
				ﾊﾞｲﾘﾆｱ補間で解像度拡張
				(□512対応完了)
----------------------------------------------------------------------------



----------------------------------------------------------------------------
<KN向け形状計測仕様>
160		151202	152を継承
				断層ﾌﾟﾛﾌｧｲﾙ表示ﾚﾝｼﾞに±50umを追加
				面補正係数演算処理を実装
161		151203	CPeakに傾斜面補正値用変数dIncを追加
				傾斜面補正値算出処理をimgInc()で実装
				CPeakを変更したので基準面取り直し
162		151203	reference.dat保存時に不要なﾃﾞｰﾀを0ｸﾘｱする様に修正
				湾曲補正のﾁｪｯｸを外してﾃﾞｰﾀﾛｰﾄﾞすると傾斜面補正に失敗する	
163		151203	OnEnChangeEdit1()をﾊﾟｽ設定
				OnBnClickedCalc()をﾊﾟｽ設定
164		151203	fileOpen()でimgCalc()の位置を変更
				imgCvFit()での参照ﾃﾞｰﾀをuFroからuFrmに変更
165		151203	OnBnClickedCurv()をimgUpdate()で実装
				imgCurv()をﾊﾟｽ設定
166		151203	ﾃﾞｰﾀﾌｧｲﾙを開くfileOpen()では湾曲補正・傾斜補正を有効に設定する
167		151203	起動時にnOrgを0ｸﾘｱして初期画像ｸﾘｱ
				傾斜補正用座標の初期化処理を分離
				OnPaint()でﾏｰｶｰ描画
				補正用座標を変更
168		151203	ptAvg()による平滑化座標取得処理を実装
169		151203	ptAvg()での配列の初期化処理を追加
				(KNｻﾝﾌﾟﾙを傾斜補正測定実施)
170		151203	背景の白点除去のためimgSurface()の処理修正
////////////////////////////////////////////////////////////////////////////////
//	Cvx_KN
//	VS2013へ移行
//	Git管理	
//	160203
////////////////////////////////////////////////////////////////////////////////
171		160203	環境移行(VS2013)
				Gitによる履歴管理開始
172		160203	Analyzeﾎﾞﾀﾝ追加
				F4に割り当て
				imgTrim()を実装しﾜｰｸ重心算出
				imgTrim()でdRでﾜｰｸ画像切出し
173		160203	imgTrim()で重心を中心に外円と内円を描画
				imgTrim()で輪郭検出
				param.hに色定義を追加
174		160203	傾斜面補正と疑似ｶﾗｰの初期値をFALSEに変更
				ﾌｧｲﾙを開いた時の傾斜補正を無効化
				内径と外形輪郭抽出
175		160203	ptIn[]とptOut[]へ輪郭ﾃﾞｰﾀ座標取得
				輪郭ﾃﾞｰﾀから平均円算出して描画
176		160204	輪郭ﾃﾞｰﾀ用ｸﾗｽCOtlを作成
				COtlで輪郭ﾃﾞｰﾀ算出
177		160204	



				





								



